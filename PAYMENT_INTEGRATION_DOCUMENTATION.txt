================================================================================
SERA PRO - PAYMENT INTEGRATION & SUBSCRIPTION FLOW DOCUMENTATION
================================================================================

Version: 1.0
Last Updated: 2024
Author: Development Team

================================================================================
TABLE OF CONTENTS
================================================================================

1. Overview
2. Architecture & Components
3. Payment Flow
4. Transaction Management
5. Subscription Activation
6. Payment Pages & User Experience
7. Analytics & Tracking
8. Error Handling
9. Security Considerations
10. Environment Variables
11. Testing Guide
12. Troubleshooting

================================================================================
1. OVERVIEW
================================================================================

This document describes the complete payment integration system for Sera Pro,
including Kashier payment gateway integration, transaction management, and
subscription activation flow.

Key Features:
- Kashier Payment Gateway Integration
- Firestore Transaction Tracking
- Automatic Subscription Activation
- Payment Confirmation Pages
- Receipt Generation
- Analytics Tracking (Google Analytics & Meta Pixel)
- Comprehensive Error Handling
- Bilingual Support (Arabic/English)

================================================================================
2. ARCHITECTURE & COMPONENTS
================================================================================

2.1 Core Files

firebase/firestore.ts
  - Transaction type definition
  - UserProfile & UserSubscription types
  - Transaction CRUD operations
  - Subscription activation functions
  - Plan configuration mapping

payments/kashier.ts
  - Kashier API wrapper
  - Payment URL generation
  - Payment Page Link (ppLink) management
  - Test/Live mode handling

app/api/payments/kashier/checkout/route.ts
  - Checkout API endpoint
  - Transaction creation
  - Payment URL generation
  - User validation

app/api/payments/activate/route.ts
  - Subscription activation endpoint
  - Transaction validation
  - User profile updates

2.2 Payment Pages

app/payment-approved/[trxReferenceNumber]/page.tsx
  - Payment success handler
  - Transaction data extraction
  - Subscription activation trigger
  - Analytics tracking
  - User confirmation display

app/payment-failed/page.tsx
  - Payment failure handler
  - Transaction status update
  - Error messaging
  - Retry options

app/receipt/page.tsx
  - Receipt display page
  - Transaction details
  - Subscription information
  - Print/Download functionality

2.3 Client Components

components/payments/PlanActionButton.tsx
  - Plan purchase initiation
  - Checkout API call
  - Redirect to Kashier

components/payments/PurchaseButtons.tsx
  - Alternative purchase component
  - Similar functionality to PlanActionButton

2.4 Analytics

lib/google-analytics.ts
  - Google Analytics event tracking
  - Purchase event tracking
  - Custom event support

lib/meta-pixel.ts
  - Meta Pixel (Facebook) event tracking
  - Purchase event tracking
  - Custom event support

================================================================================
3. PAYMENT FLOW
================================================================================

3.1 Payment Initiation Flow

Step 1: User Selects Plan
  - User clicks "Purchase" button on pricing page
  - PlanActionButton component handles the click

Step 2: Create Pending Transaction
  - Client calls: POST /api/payments/kashier/checkout
  - API validates user and plan
  - Creates pending Transaction in Firestore (/transactions/{transactionId})
  - Transaction status: "1" (pending)
  - Generates orderId and trxReferenceNumber

Step 3: Generate Kashier Payment URL
  - API calls createKashierCheckout() from payments/kashier.ts
  - Selects appropriate Payment Page Link (ppLink) based on:
    * Plan type (one_time, flex_pack, annual_pass)
    * Mode (test or live)
  - Constructs Kashier payment URL:
    https://checkouts.kashier.io/en/paymentpage?ppLink={ppLink},{mode}
  - Includes success and cancel URLs with transactionId

Step 4: Redirect to Kashier
  - Client receives payment URL and transactionId
  - Performs full-page redirect: window.location.href = checkoutUrl
  - User completes payment on Kashier's secure payment page

3.2 Payment Completion Flow

Step 5: Kashier Redirects User
  - On Success: Redirects to /payment-approved/{trxReferenceNumber}?status=success&...
  - On Failure: Redirects to /payment-failed?status=cancel&...

Step 6: Payment-Approved Page Processing
  - Extracts trxReferenceNumber from URL path
  - Extracts payment data from query parameters
  - URL decodes all parameter values
  - Maps parameters to Transaction model fields

Step 7: Update Transaction
  - Queries Firestore for transaction by trxReferenceNumber or transactionId
  - Validates transaction belongs to authenticated user
  - Checks for duplicate updates (idempotency)
  - Updates transaction with payment completion data:
    * paymentStatus: "2" (success)
    * maskedCard, cardBrand, cardDataToken
    * merchantOrderId, orderReference, signature
    * updatedAt, completedAt timestamps

Step 8: Activate Subscription
  - Calls: POST /api/payments/activate
  - Passes transactionId
  - Activation API:
    * Fetches transaction from Firestore
    * Validates paymentStatus = "2" (success)
    * Calls activateSubscriptionFromTransaction()
    * Uses Firestore batched writes for atomicity

Step 9: Subscription Activation Details
  - Copies subscription details from Transaction to UserProfile
  - Calculates subscriptionValidUntil from plan duration
  - Sets subscriptionIsActive = true (via status: "active")
  - Updates lastTransactionId in user profile
  - Adds entry to subscriptionHistory array
  - All updates in single atomic batch operation

Step 10: Analytics Tracking
  - Fires Google Analytics Purchase event
  - Fires Meta Pixel Purchase event
  - Includes transaction details (amount, currency, plan, etc.)
  - Non-blocking (errors don't fail payment processing)

Step 11: User Confirmation
  - Displays payment confirmation page
  - Shows transaction summary
  - Displays subscription expiration date
  - Provides navigation to dashboard and CV builder
  - Auto-redirects to dashboard after 5 seconds

================================================================================
4. TRANSACTION MANAGEMENT
================================================================================

4.1 Transaction Data Model

Location: firebase/firestore.ts

Transaction Type:
  - transactionId: string (document ID)
  - subscriptionPlanId: "one_time" | "flex_pack" | "annual_pass"
  - subscriptionPlanName: string
  - subscriptionPlanPrice: string
  - subscriptionPlanDuration: string
  - subscriptionPlanDurationType: "days" | "months" | "year"
  - subscriptionPlanDescription: string
  - userId: string (Firebase Auth UID)
  - userEmail: string
  - userName: string
  - userPhone?: string
  - transactionAmount: string
  - transactionCurrency: string
  - paymentStatus: "1" | "2" | "3" ("1"=pending, "2"=success, "3"=failed)
  - language: "ar" | "en"
  - trxReferenceNumber: string (Kashier transaction reference)
  - cardDataToken?: string
  - maskedCard?: string
  - merchantOrderId: string
  - orderId: string
  - orderReference?: string
  - cardBrand?: string
  - mode: "test" | "live"
  - signature?: string
  - createdBy: string
  - createdAt: Firestore Timestamp
  - updatedAt: Firestore Timestamp
  - completedAt?: Firestore Timestamp

4.2 Transaction Functions

createTransaction()
  - Creates new pending transaction
  - Status: "1" (pending)
  - Called before redirecting to Kashier
  - Returns transactionId

getTransaction(transactionId)
  - Fetches transaction by document ID
  - Returns Transaction object

getTransactionByReference(trxReferenceNumber)
  - Fetches transaction by Kashier reference
  - Queries Firestore collection
  - Returns Transaction object

updateTransactionWithPaymentData(transactionId, paymentData)
  - Updates transaction with payment completion data
  - Sets paymentStatus to "2" (success) or "3" (failed)
  - Updates payment fields (maskedCard, cardBrand, etc.)
  - Sets updatedAt and completedAt timestamps
  - Validates transaction exists before updating

listUserTransactions(userId)
  - Lists all transactions for a user
  - Sorted by createdAt (newest first)
  - Supports pagination

getLastSuccessfulTransaction(userId)
  - Gets most recent successful transaction
  - Used for subscription history

4.3 Transaction Status Flow

"1" (Pending)
  - Initial state when transaction is created
  - Before payment is completed

"2" (Success)
  - Payment completed successfully
  - Subscription activated
  - Transaction updated with payment details

"3" (Failed)
  - Payment failed or cancelled
  - No subscription activation
  - Transaction marked as failed

================================================================================
5. SUBSCRIPTION ACTIVATION
================================================================================

5.1 Subscription Data Model

Location: firebase/firestore.ts

UserSubscription Type:
  - plan: "free" | "one_time" | "flex_pack" | "annual_pass"
  - status: "active" | "inactive" | "cancelled" | "expired"
  - startDate: Firestore Timestamp
  - expirationDate?: Firestore Timestamp
  - renewalDate?: Firestore Timestamp
  - paymentMethod?: string
  - lastPaymentDate?: Firestore Timestamp
  - nextBillingDate?: Firestore Timestamp
  - creditsRemaining?: number (for flex_pack)
  - validUntil?: Firestore Timestamp
  - subscriptionHistory?: SubscriptionHistoryEntry[]

SubscriptionHistoryEntry Type:
  - transactionId: string
  - plan: "one_time" | "flex_pack" | "annual_pass"
  - activatedAt: Firestore Timestamp
  - validUntil: Firestore Timestamp
  - amount: string
  - currency: string
  - trxReferenceNumber?: string

5.2 Activation Function

activateSubscriptionFromTransaction(transactionId)
  - Fetches transaction from Firestore
  - Validates paymentStatus = "2" (success)
  - Fetches user profile
  - Calculates subscription expiration date from plan duration
  - Creates subscription history entry
  - Updates user profile with:
    * subscription.plan
    * subscription.status = "active"
    * subscription.validUntil
    * subscription.expirationDate
    * subscription.lastPaymentDate
    * subscription.subscriptionHistory (appends new entry)
    * lastTransactionId
  - Uses Firestore batched writes for atomicity
  - All updates succeed or fail together

5.3 Plan Duration Calculation

One-Time Purchase:
  - Duration: 7 days
  - expirationDate = now + 7 days

Flex Pack:
  - Duration: 6 months
  - expirationDate = now + 6 months
  - creditsRemaining = 5

Annual Pass:
  - Duration: 12 months (1 year)
  - expirationDate = now + 1 year
  - renewalDate = expirationDate
  - nextBillingDate = expirationDate

5.4 Subscription Features

One-Time Purchase:
  - 1 CV
  - 3 Templates
  - Unlimited edits for 7 days
  - No watermark

Flex Pack:
  - 5 CV credits
  - All templates
  - 6 months validity
  - No watermark

Annual Pass:
  - Unlimited CVs
  - All templates
  - Cover letter tools
  - Future features
  - 1 year validity

================================================================================
6. PAYMENT PAGES & USER EXPERIENCE
================================================================================

6.1 Payment-Approved Page

Route: /payment-approved/[trxReferenceNumber]

Features:
  - Extracts transaction reference from URL path
  - Extracts payment data from query parameters
  - URL decodes all values
  - Validates transaction exists and belongs to user
  - Updates transaction with payment data
  - Activates subscription
  - Tracks analytics events
  - Displays confirmation with:
    * Plan name
    * Amount paid
    * Subscription expiration date
    * Transaction ID
    * Payment reference
    * Card information (masked)
    * Support contact info
  - Navigation buttons:
    * Go to Dashboard
    * View Receipt
    * Create CV Now
  - Auto-redirects to dashboard after 5 seconds

6.2 Payment-Failed Page

Route: /payment-failed

Features:
  - Handles failed or cancelled payments
  - Updates transaction status to "3" (failed)
  - Displays error message
  - Provides retry options
  - Shows support contact information
  - Navigation buttons:
    * Try Again (redirects to pricing)
    * Go to Dashboard

6.3 Receipt Page

Route: /receipt?transactionId={id} OR /receipt?trxReferenceNumber={ref}

Features:
  - Fetches transaction and user profile
  - Validates transaction belongs to user
  - Displays comprehensive receipt:
    * Plan details (name, features, purchase date)
    * Transaction details (amount, status, IDs, payment method)
    * Subscription validity period
    * User contact information
    * Active subscription confirmation
  - Print functionality
  - Download functionality
  - Support contact information
  - Navigation buttons:
    * Go to Dashboard
    * Create CV Now

6.4 User Experience Flow

1. User selects plan → Pricing page
2. User clicks "Purchase" → PlanActionButton
3. Transaction created → Pending status
4. Redirect to Kashier → Payment page
5. User completes payment → Kashier processes
6. Redirect to payment-approved → Success page
7. Transaction updated → Status: Success
8. Subscription activated → Features enabled
9. Analytics tracked → Conversion events
10. Confirmation displayed → User sees success
11. Auto-redirect to dashboard → User can start using features
12. Receipt available → User can view/download receipt

================================================================================
7. ANALYTICS & TRACKING
================================================================================

7.1 Google Analytics Integration

File: lib/google-analytics.ts

Events Tracked:
  - purchase: Payment completion
    * value: Purchase amount
    * currency: Currency code (EGP)
    * transaction_id: Transaction ID
    * items: Array with plan details

Implementation:
  - trackPurchase() function
  - Fired after successful subscription activation
  - Non-blocking (errors don't fail payment)

7.2 Meta Pixel Integration

File: lib/meta-pixel.ts

Events Tracked:
  - Purchase: Payment completion
    * value: Purchase amount
    * currency: Currency code (EGP)

Implementation:
  - trackPurchase() function
  - Fired after successful subscription activation
  - Non-blocking (errors don't fail payment)

7.3 Analytics Flow

1. Payment completed successfully
2. Subscription activated
3. Analytics events fired:
   - Google Analytics Purchase event
   - Meta Pixel Purchase event
4. Events include:
   - Transaction ID
   - Purchase amount
   - Currency
   - Plan type
   - Plan name
5. Errors logged but don't block payment processing

7.4 Error Monitoring

Optional Integration:
  - Sentry or similar error monitoring
  - Error tracking for:
    * Analytics failures
    * Payment processing errors
  - Comments in code indicate where to add error tracking

================================================================================
8. ERROR HANDLING
================================================================================

8.1 Transaction Creation Errors

- Invalid user: Returns 400 error
- Missing user profile: Returns 404 error
- Invalid product: Returns 400 error
- Transaction creation failure: Returns 500 error
- Kashier API error: Returns 500 error with details

8.2 Payment Processing Errors

- Missing transaction reference: Error message displayed
- Transaction not found: Error message with support contact
- Transaction belongs to different user: Security error
- Payment status not successful: Error message
- Duplicate callback: Idempotency check prevents re-processing

8.3 Subscription Activation Errors

- Transaction not found: Returns 404 error
- Transaction not successful: Returns 400 error
- User profile not found: Returns 404 error
- Firestore write failure: Returns 500 error
- Race condition: Firestore handles concurrent updates

8.4 Error Recovery

- Network errors: User can retry payment
- Transaction update failures: Transaction still created, can be manually activated
- Activation failures: Transaction updated, support can manually activate
- Analytics failures: Non-critical, logged but don't block payment

8.5 User-Facing Error Messages

All error messages are:
- Bilingual (Arabic/English)
- Clear and actionable
- Include support contact information
- Provide navigation options (retry, dashboard, etc.)

================================================================================
9. SECURITY CONSIDERATIONS
================================================================================

9.1 Server-Side Processing

- Payment Page Links (ppLink) stored as environment variables
- Never exposed to client
- Payment URLs generated server-side only
- API keys and secrets never sent to client

9.2 Transaction Validation

- User authentication required
- Transaction ownership verified
- Payment status validated before activation
- Duplicate update detection (idempotency)

9.3 Data Protection

- Sensitive payment data stored securely in Firestore
- Card data tokenized (cardDataToken)
- Masked card numbers only (maskedCard)
- No full card numbers stored

9.4 Firestore Security Rules

Recommended Rules:
  - Users can only read their own transactions
  - Users can only create transactions for themselves
  - Only server can update transaction payment status
  - Subscription updates require authentication

9.5 URL Parameter Validation

- All URL parameters URL decoded
- Input validation on all parameters
- Type checking for all values
- Sanitization before database writes

================================================================================
10. ENVIRONMENT VARIABLES
================================================================================

10.1 Kashier Configuration

KASHIER_MERCHANT_ID
  - Kashier merchant ID
  - Used for API authentication
  - Required for checkout URL generation

KASHIER_SECRET_KEY
  - Kashier secret key
  - Used for API authentication
  - Never exposed to client

KASHIER_MODE
  - Payment mode: "test" or "live"
  - Determines which environment to use
  - Defaults to "test" if not set

10.2 Payment Page Links (ppLink)

Production Links:
  KASHIER_PPLINK_ONETIME=PP-XXXXX
  KASHIER_PPLINK_FLEXPACK=PP-XXXXX
  KASHIER_PPLINK_ANNUALPASS=PP-XXXXX

Test/Sandbox Links:
  KASHIER_PPLINK_ONETIME_TEST=PP-XXXXX
  KASHIER_PPLINK_FLEXPACK_TEST=PP-XXXXX
  KASHIER_PPLINK_ANNUALPASS_TEST=PP-XXXXX

Note: Each plan has separate Payment Page Links for test and live modes.

10.3 Analytics

NEXT_PUBLIC_GA_TRACKING_ID
  - Google Analytics tracking ID
  - Format: G-XXXXXXXXXX
  - Public (exposed to client)

NEXT_PUBLIC_META_PIXEL_ID
  - Meta Pixel (Facebook) ID
  - Format: 15-digit number
  - Public (exposed to client)

10.4 Application URLs

NEXT_PUBLIC_APP_URL
  - Base URL for the application
  - Used for redirect URLs
  - Example: https://serapro.com

VERCEL_URL
  - Vercel deployment URL (auto-set)
  - Fallback if NEXT_PUBLIC_APP_URL not set

================================================================================
11. TESTING GUIDE
================================================================================

11.1 Test Mode Setup

1. Set KASHIER_MODE=test
2. Use test Payment Page Links (KASHIER_PPLINK_*_TEST)
3. Use test merchant credentials
4. Test with test card numbers provided by Kashier

11.2 Test Scenarios

Successful Payment:
  1. Select plan
  2. Complete payment with test card
  3. Verify transaction created in Firestore
  4. Verify transaction updated with payment data
  5. Verify subscription activated
  6. Verify analytics events fired
  7. Verify confirmation page displays
  8. Verify receipt page accessible

Failed Payment:
  1. Select plan
  2. Cancel payment or use invalid card
  3. Verify transaction created in Firestore
  4. Verify transaction status = "3" (failed)
  5. Verify subscription NOT activated
  6. Verify error page displays
  7. Verify retry functionality

Duplicate Callback:
  1. Complete successful payment
  2. Manually trigger callback again (simulate duplicate)
  3. Verify idempotency check prevents duplicate update
  4. Verify subscription not activated twice

Missing Transaction:
  1. Access payment-approved page with invalid transaction ID
  2. Verify error message displays
  3. Verify support contact information shown

Unauthorized Access:
  1. Try to access receipt for another user's transaction
  2. Verify security error displays
  3. Verify transaction not accessible

11.3 Integration Testing

Test Payment Flow End-to-End:
  1. User registration/login
  2. Plan selection
  3. Payment initiation
  4. Payment completion
  5. Subscription activation
  6. Feature access verification
  7. Receipt generation
  8. Analytics tracking

11.4 Edge Cases

- Network failures during payment
- Concurrent payment attempts
- Expired sessions during payment
- Missing user profile
- Invalid plan types
- Malformed URL parameters
- Firestore unavailability

================================================================================
12. TROUBLESHOOTING
================================================================================

12.1 Common Issues

Issue: Payment URL not generated
  - Check KASHIER_MERCHANT_ID and KASHIER_SECRET_KEY
  - Verify Payment Page Links (ppLink) are set
  - Check KASHIER_MODE is correct
  - Verify plan type matches available plans

Issue: Transaction not found after payment
  - Check transaction was created before redirect
  - Verify trxReferenceNumber matches
  - Check Firestore security rules
  - Verify user authentication

Issue: Subscription not activated
  - Check transaction paymentStatus = "2"
  - Verify user profile exists
  - Check Firestore write permissions
  - Review activation API logs

Issue: Analytics not tracking
  - Verify GA_TRACKING_ID and META_PIXEL_ID are set
  - Check browser console for errors
  - Verify analytics scripts loaded
  - Check ad blockers (may block tracking)

Issue: Receipt page not accessible
  - Verify transactionId or trxReferenceNumber provided
  - Check transaction belongs to authenticated user
  - Verify transaction paymentStatus = "2"
  - Check Firestore read permissions

12.2 Debugging Steps

1. Check browser console for errors
2. Check server logs for API errors
3. Verify Firestore data:
   - Transaction document exists
   - Transaction status is correct
   - User profile subscription updated
4. Verify environment variables set correctly
5. Check network requests in browser DevTools
6. Verify redirect URLs are correct

12.3 Support Contacts

For technical issues:
  - Check Firestore console for transaction data
  - Review API route logs
  - Verify Kashier dashboard for payment status
  - Contact development team with:
    * Transaction ID
    * User ID
    * Error messages
    * Browser console logs

For user support:
  - Email: support@serapro.com
  - Provide transaction ID or reference number
  - Include user email address

================================================================================
APPENDIX A: FILE STRUCTURE
================================================================================

firebase/
  firestore.ts                    - Transaction & subscription management

payments/
  kashier.ts                      - Kashier API integration

app/api/payments/
  kashier/checkout/route.ts       - Checkout API endpoint
  activate/route.ts               - Activation API endpoint

app/payment-approved/
  [trxReferenceNumber]/page.tsx  - Payment success handler

app/payment-failed/
  page.tsx                        - Payment failure handler

app/receipt/
  page.tsx                        - Receipt display page

components/payments/
  PlanActionButton.tsx            - Plan purchase button
  PurchaseButtons.tsx             - Alternative purchase component

lib/
  google-analytics.ts             - Google Analytics tracking
  meta-pixel.ts                   - Meta Pixel tracking

================================================================================
APPENDIX B: API ENDPOINTS
================================================================================

POST /api/payments/kashier/checkout
  Query Parameters:
    - product: "one_time" | "flex_pack" | "annual_pass"
    - userId: Firebase Auth UID
  
  Response:
    - url: Kashier payment URL
    - transactionId: Transaction document ID

POST /api/payments/activate
  Body:
    - transactionId: Transaction document ID
  
  Response:
    - ok: true
    - message: "Subscription activated successfully"
    - transactionId: Transaction ID
    - userId: User ID
    - plan: Plan ID

================================================================================
APPENDIX C: KASHIER CONFIGURATION
================================================================================

Kashier Dashboard Setup:
  1. Create Payment Pages for each plan:
     - One-Time Purchase
     - Flex Pack
     - Annual Pass
  2. Create separate Payment Pages for test mode
  3. Configure redirect URLs:
     - Success: https://yourdomain.com/payment-approved/{trxReferenceNumber}
     - Failure: https://yourdomain.com/payment-failed
  4. Copy Payment Page Link IDs (ppLink) to environment variables
  5. Set merchant ID and secret key in environment variables

Payment Page Link Format:
  - Format: PP-XXXXX
  - Each plan has unique ppLink
  - Separate ppLinks for test and live modes

================================================================================
END OF DOCUMENTATION
================================================================================

For questions or updates, contact the development team.

